name: verbose-image-build

on:
  workflow_dispatch:

env:
  REGISTRY_IMAGE: sureserver/tor-socat

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-verbose:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/riscv64
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare platform label
        run: |
          platform="${{ matrix.platform }}"
          echo "PLATFORM_PAIR=${platform//\//-}" >> "$GITHUB_ENV"

      - name: Build with maximal verbosity
        run: |
          set -euo pipefail
          log_file="build-${PLATFORM_PAIR}.log"
          docker buildx build \
            --progress=plain \
            --pull \
            --platform "${{ matrix.platform }}" \
            --tag "${REGISTRY_IMAGE}:${PLATFORM_PAIR}-verify" \
            --provenance=false \
            --sbom=false \
            . 2>&1 | tee "$log_file"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: verbose-build-${{ env.PLATFORM_PAIR }}
          path: build-${{ env.PLATFORM_PAIR }}.log
          if-no-files-found: error
          retention-days: 7
